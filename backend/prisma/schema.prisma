// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum ReviewStatus {
  PUBLISHED
  PENDING
  HIDDEN
  FLAGGED
}

enum Role {
  USER
  HOST
  ADMIN
}

enum PaymentStatus {
   INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  RAZORPAY
}

enum PropertyStatus {
  PENDING
  ACTIVE
  INACTIVE
  REJECTED
  DELETED
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  CANCELLED
  COMPLETED
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String   @unique
  password  String
  phone     String?
  avatarUrl String?
  role      Role     @default(USER) // 'user' |'host'|'admin'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
Otps Otp[]
payments    Payment[]
  properties   Property[]
  bookings     Booking[]
  reviews      Review[]
  favorites    Favorite[]
  sentMsgs     Message[]  @relation("SentMessages")
  receivedMsgs Message[]  @relation("ReceivedMessages")
}
model Otp {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  code       String
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
model Property {
  id            String                 @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  description   String
  price         Float
  country       String                 @default("India")
  state         String
  city          String
  address       String?
  lat           Float?
  lng           Float?
  capacity      Int
  bedrooms      Int
  bathrooms     Int
  images        String[]
  amenities     String[]               @default([])
  status        PropertyStatus         @default(PENDING) // pending | active | inactive | rejected
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  averageRating Float                  @default(0)
  reviewCount   Int                    @default(0)
  owner         User                   @relation(fields: [ownerId], references: [id])
  ownerId       String                 @db.ObjectId
  bookings      Booking[]
  reviews       Review[]
  favorites     Favorite[]
  availability  PropertyAvailability[]
}

model Booking {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  startDate  DateTime
  endDate    DateTime
  totalPrice Float
  status     BookingStatus @default(PENDING_PAYMENT) //confirmed | cancelled | completed
  paymentId  String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  capacity   Int
  review     Review?
  payment Payment?
  user       User          @relation(fields: [userId], references: [id])
  userId     String        @db.ObjectId
  property   Property      @relation(fields: [propertyId], references: [id])
  propertyId String        @db.ObjectId
}

model Review {
  id         String       @id @default(auto()) @map("_id") @db.ObjectId
  userId     String       @db.ObjectId
  rating     Int
  comment    String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  property   Property     @relation(fields: [propertyId], references: [id])
  propertyId String       @db.ObjectId
  user       User         @relation(fields: [userId], references: [id])
  status     ReviewStatus @default(PUBLISHED)
  booking    Booking      @relation(fields: [bookingId], references: [id])
  bookingId  String       @unique @db.ObjectId
}

model Favorite {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])
  userId     String   @db.ObjectId
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String   @unique @db.ObjectId

  @@unique([userId, propertyId])
}

model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Sender     User   @relation("SentMessages", fields: [senderId], references: [id])
  senderId   String @db.ObjectId
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id])
  receiverId String @db.ObjectId
}

model PropertyAvailability {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  propertyId String   @db.ObjectId
  startTime  DateTime
  endTime    DateTime
  isBlocked  Boolean  @default(true)
  createdAt  DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id])
}

model Payment {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId

  amount    Float
  currency  String        @default("INR")
  status    PaymentStatus @default(INITIATED)

  provider  PaymentProvider
  providerPaymentId String?

  bookingId String   @unique @db.ObjectId
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])

  failureReason String?
  rawWebhook    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerPaymentId])
}